function Sprite(t,e,i,n,s){this.img=t,this.x=2*e,this.y=2*i,this.width=2*n,this.height=2*s}function initSprites(t){s_splash=new Sprite(t,32,0,16,15),s_door=[new Sprite(t,0,48,16,16),new Sprite(t,16,48,16,16)],s_play_btn=new Sprite(t,32,16,74,23),s_menu_btn=new Sprite(t,32,40,74,23),s_player=[new Sprite(t,0,0,16,16),new Sprite(t,16,0,16,16)],s_spider=[new Sprite(t,0,64,16,8),new Sprite(t,0,73,16,8)],s_zombie=[new Sprite(t,0,16,16,16),new Sprite(t,16,16,16,16)],s_bomb=new Sprite(t,49,0,16,16),s_logo=new Sprite(t,32,64,192,88),s_world_block=new Sprite(t,16,32,16,16),s_world_air=new Sprite(t,0,32,16,16)}function GameStateManager(){var t;this.changeState=function(e){switch(null!=t&&t.dispose(),e){default:case states.Splash:t=new Splash,t.init();break;case states.Menu:t=new Menu,t.init();break;case states.Play:t=new Play,t.init();break;case states.GameOver:t=new GameOver,t.init()}},this.onClick=function(e){t.onClick(e)},this.update=function(e){t.update(e)},this.render=function(){t.render()},this.debug=function(){t.debug()},this.dispose=function(){t.dispose()},this.getState=function(){return t}}function Splash(){const t=2;var e,i,n,s;this.init=function(){var o=canvas.width/2-s_splash.width/2/2,a=canvas.height/2-s_splash.height/2/2;e=new Vector2(o,a),i=new Date,n=new Date,n.setSeconds(n.getSeconds()+t),s=1},this.onClick=function(){gsm.changeState(states.Menu)},this.update=function(){n<new Date&&gsm.changeState(states.Menu),s-=.0055},this.render=function(){ctx.save(),ctx.globalAlpha=s,ctx.scale(8,8),s_splash.draw(15,10),ctx.scale(1,1),ctx.globalAlpha=1,ctx.restore()},this.debug=function(){},this.dispose=function(){e.dispose()}}function Menu(){var t;this.init=function(){var e=canvas.width/2-s_play_btn.width/2/2,i=canvas.height/2-s_play_btn.height/2/2;t=new Button(s_play_btn,e,i+70)},this.onClick=function(e){Boolean(t.onClick(e))&&gsm.changeState(states.Play)},this.update=function(t){},this.render=function(){ctx.save(),ctx.scale(2,2),s_logo.draw(40,10),ctx.restore(),t.render()},this.debug=function(){t.debug(),ctx.beginPath(),ctx.moveTo(canvas.width/2,0),ctx.lineTo(canvas.width/2,canvas.height),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,canvas.height/2),ctx.lineTo(canvas.width,canvas.height/2),ctx.stroke()},this.dispose=function(){}}function Play(){const t=10,e=100;var i=0;this.init=function(){this.world=new World,this.player=new Player,this.player.init(),this.gui=new Gui(this),this.entityManager=new EntityManager(this.world),this.entityManager.init(),this.bombManager=new WeaponManager,this.bombManager.init(),this.score=new Score,this.reset()},this.onClick=function(t){this.player.onClick(t);var e=canvas.getBoundingClientRect(),i=event.clientX-e.left,n=event.clientY-e.top,s=i>0&&i<canvas.width&&n>0&&n<canvas.height;s&&this.bombManager.newBomb(this.player.position)},this.reset=function(){this.world.reset(i);var t=this.world.spawnCell();this.player.setPosition(t.position.x*Cell.SIZE,t.position.y*Cell.SIZE),this.entityManager.reset(i),this.bombManager.reset(),this.entityManager.addXEnemy(i),this.timer=new Time,this.timer.startTimer(e+i)},this.update=function(e){this.world.update(e),this.player.update(e),this.entityManager.update(e),this.bombManager.update(),this.entityManager.collides(this.player.bounds),this.entityManager.isEmpty()&&(this.world.activateDoor(),this.world.collideWithDoor(this.player)&&(this.score.addScore(t),this.nextLevel())),this.gui.update(e),this.timer.isFinished()&&gsm.changeState(states.GameOver)},this.nextLevel=function(){mute||document.getElementById("audio_next_level").play(),i++,this.score.saveScore(),this.reset()},this.render=function(){this.world.render(),this.entityManager.render(),this.bombManager.render(),this.player.render(),this.gui.render()},this.debug=function(){ctx.fillStyle="red",ctx.strokeStyle="green",ctx.lineWidth="1",ctx.font="10px Arial",ctx.fontcolor="orange",ctx.globalAlpha=.5,this.world.debug(ctx),this.entityManager.debug(ctx),this.bombManager.debug(),this.player.debug(ctx),this.gui.debug(ctx),ctx.globalAlpha=1},this.dispose=function(){this.world.dispose(),delete this.world,this.player.dispose(),delete this.player,this.entityManager.dispose(),delete this.entityManager,this.bombManager.dispose(),delete this.bombManager,this.gui.dispose(),delete this.gui,this.score.saveAll(),this.score.dispose(),delete this.score}}function GameOver(){var t,e,i;this.init=function(){t=new Score,t.loadAll();var n=100,s=350;e=new Button(s_play_btn,n,s),i=new Button(s_menu_btn,canvas.width-n-s_menu_btn.width/2,s)},this.onClick=function(t){e.onClick(t)&&gsm.changeState(states.Play),i.onClick(t)&&gsm.changeState(states.Menu)},this.update=function(){},this.render=function(){ctx.font="24px Helvetica",ctx.textAlign="center",ctx.textBaseline="top",ctx.fillStyle="red",ctx.font="70pt Calibri",ctx.fillText("GameOver!",canvas.width/2,canvas.height/2-150),ctx.fillStyle="white",ctx.font="40pt Calibri",ctx.fillText("Your Score is: "+t.getScore(),canvas.width/2,canvas.height/2-20),ctx.fillText("HighScore: "+t.getBests(),canvas.width/2,canvas.height/2- -40),i.render(),e.render()},this.debug=function(){i.debug(),e.debug()},this.dispose=function(){}}function Vector2(t,e){this.x=t,this.y=e,this.reset=function(){this.x=0,this.y=0},this.isZero=function(){return Boolean(0===this.x&&0===this.y)},this.dispose=function(){delete this.x,delete this.y}}function Bound(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n,this.setPosition=function(t,e){this.x=t,this.y=e},this.debug=function(){ctx.fillRect(this.x,this.y,this.width,this.height)},this.collideWith=function(t){var e=Boolean(this.x<t.x+t.width),i=Boolean(this.x+this.width+100>t.x),n=Boolean(this.y<t.y+t.height),s=Boolean(this.y-this.height>t.y);return Boolean(e&&i&&n&&s)},this.collideWithEntity=function(t){var e=Boolean(this.x<t.x+t.width),i=Boolean(this.x+this.width>t.x),n=Boolean(this.y<t.y+t.height),s=Boolean(this.y+this.height>t.y);return Boolean(e&&i&&n&&s)},this.dispose=function(){delete this.x,delete this.y,delete this.width,delete this.height}}function Button(t,e,i){var n=t,s=new Vector2(e,i),o=new Bound(e,i,n.width/2,n.height);this.onClick=function(t){var e=canvas.getBoundingClientRect();return Boolean(a(t.clientX-e.left,t.clientY-e.top))},this.update=function(t){},this.render=function(){n.draw(s.x,s.y)},this.debug=function(){o.debug()};var a=function(t,e){return!!(t>o.x&&t<o.x+o.width&&e>o.y&&e<o.y+o.height)}}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t)+t)}function isNull(t){return Boolean("undefined"===t||null==t)}function EntityManager(t){var e={SPIDER:0,ZOMBIE:1},i=t,n=[];this.init=function(){},this.addXEnemy=function(t){for(var e=0;t>e;e++)this.addNewEnemy()},this.addNewEnemy=function(){var t=s();t.init();var e=i.spawnCell();t.setPosition(e.position.x*Cell.SIZE,e.position.y*Cell.SIZE),o(t)};var s=function(){var t;switch(t=getRandomInt(0,2)){case e.SPIDER:return new Spider;case e.ZOMBIE:return new Zombie;default:return console.error("states.entityManager.createRandomEnemy"),new Enemy}},o=function(t){n.push(t)};this.collides=function(t){for(var e=0;e<n.length;e++)Boolean(t.collideWithEntity(n[e].getBounds()))&&(mute||document.getElementById("audio_kill").play(),gsm.getState().score.addScore(Number(1)),this.removeEnemy(n[e]))},this.isEmpty=function(){return Boolean(n.length<=0)},this.removeEnemy=function(t){for(;-1!==n.indexOf(t);)n.splice(n.indexOf(t),1)},this.reset=function(){n=[]},this.update=function(){if(!this.isEmpty()){for(var t=0;t<n.length;t++)n[t].update();a()}};var a=function(){for(var t=5,e=0;t>e;e++){var i=getRandomInt(0,n.length);n[i].randomUpdate()}};this.render=function(){if(!this.isEmpty())for(var t=0;t<n.length;t++)n[t].render()},this.debug=function(){if(!this.isEmpty())for(var t=0;t<n.length;t++)n[t].debug()},this.dispose=function(){}}function Time(){function t(t,o){e=t,s=setInterval(function(){i=parseInt(e/60,10),n=parseInt(e%60,10),i=10>i?"0"+i:i,n=10>n?"0"+n:n,--e<0&&(e=t,o.setFinished(!0),clearInterval(s))},1e3)}var e,i,n;this.finished=!1;var s;this.startTimer=function(e){s=setInterval(t(e,this),1e3)},this.setFinished=function(t){this.finished=Boolean(t)},this.isFinished=function(){return Boolean(this.finished)},this.getMinutes=function(){return i},this.getSeconds=function(){return n}}function Score(){var t=0,e=0;this.getScore=function(){return t},this.addScore=function(e){t+=parseInt(e)},this.getBests=function(){return e},this.reset=function(){t=0},this.loadAll=function(){this.loadPrevScore(),this.loadHigh()},this.loadHigh=function(){e=parseInt(localStorage.getItem("high"))},this.loadPrevScore=function(){t=parseInt(localStorage.getItem("score"))},this.saveScore=function(){localStorage.setItem("score",t)},this.saveAll=function(){this.loadHigh(),null!==e?t>e&&(localStorage.setItem("high",t),console.log("isbest "+t+" - "+e)):localStorage.setItem("high",t)},this.dispose=function(){}}function WeaponManager(){var t=[];this.init=function(){},this.newBomb=function(t){var i=new Bomb(new Vector2(t.x,t.y));e(i)};var e=function(e){t.push(e)};this.isEmpty=function(){return Boolean(t.length<=0)};var i=function(e){for(;-1!==t.indexOf(e);)t.splice(t.indexOf(e),1)};this.reset=function(){t=[]},this.update=function(){if(!this.isEmpty())for(var e=0;e<t.length;e++)isNull(t[e])||(t[e].needsExplode()?(t[e].explode(),mute||document.getElementById("sound_explosion").play(),i(t[e])):t[e].update())},this.render=function(){if(!this.isEmpty())for(var e=0;e<t.length;e++)t[e].render()},this.debug=function(){if(!this.isEmpty())for(var e=0;e<t.length;e++)t[e].debug()},this.dispose=function(){}}function Bomb(t){const e=4,i=100;var n=t,s=new Bound(n.x-Cell.SIZE*e+s_bomb.width,n.y-Cell.SIZE*e+s_bomb.height,Cell.SIZE*e,Cell.SIZE*e),o=new Bound(n.x,n.y-Cell.SIZE*e+s_bomb.height,Cell.SIZE*e,Cell.SIZE*e),a=new Bound(n.x-Cell.SIZE*e+s_bomb.width,n.y,Cell.SIZE*e,Cell.SIZE*e),h=new Bound(n.x,n.y,Cell.SIZE*e,Cell.SIZE*e),r=0;this.update=function(){r+=1},this.render=function(){s_bomb.draw(n.x,n.y)},this.needsExplode=function(){return Boolean(r>i)},this.explode=function(){var t;t=gsm.getState(),t.entityManager.collides(s),t.entityManager.collides(o),t.entityManager.collides(a),t.entityManager.collides(h);var e=t.player.bounds.collideWithEntity(s)||t.player.bounds.collideWithEntity(o)||t.player.bounds.collideWithEntity(a)||t.player.bounds.collideWithEntity(h);if(e){var i=t.world.spawnCell();t.player.setPosition(i.position.x*Cell.SIZE,i.position.y*Cell.SIZE)}},this.debug=function(){s.debug(),o.debug(),a.debug(),h.debug()},this.dispose=function(){}}function Gui(t){var e=canvas.width/2,i=t;this.init=function(){},this.update=function(t){},this.render=function(){ctx.fillStyle="rgb(250,250,250)",ctx.font="24px Helvetica",ctx.textAlign="center",ctx.textBaseline="top";var t=i.timer.getMinutes(),n=i.timer.getSeconds();ctx.globalAlpha=.3,ctx.fillStyle="gray",ctx.fillRect(150,0,207,60),ctx.globalAlpha=1,ctx.fillStyle="white",isNaN(n)||isNaN(t)||(3>n&&(ctx.fillStyle="red"),ctx.fillText("Time Left: "+t+":"+n,e,0)),ctx.fillStyle="white",ctx.fillText("Points: "+i.score.getScore(),e,30)},this.debug=function(){},this.dispose=function(){}}function Enemy(t){const e=32;var i=0;this.animation=t,this.position=new Vector2(0,0),this.bounds=new Bound(this.position.x,this.position.y,e,e),this.init=function(){},this.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.bounds.x=t,this.bounds.y=e},this.randomUpdate=function(){},this.update=function(){this.bounds.setPosition(this.position.x,this.position.y),this.updateAnimation()},this.updateAnimation=function(){var t=10;i+=frames%t===0?1:0,i%=this.animation.length},this.getFrame=function(){return i},this.render=function(){},this.debug=function(){ctx.fillStyle="red",this.bounds.debug()},this.getBounds=function(){return this.bounds},this.setBounds=function(t,e){this.bounds.width=t,this.bounds.height=e}}function Spider(){var t=new Enemy([0,1]),e=new RandomMovement(t,4);this.init=function(){t.init(),t.setBounds(32,16)},this.randomUpdate=function(){e.randomUpdate()},this.setPosition=function(e,i){t.setPosition(e,i)},this.update=function(i){t.update(i,this),e.update(t)},this.render=function(){s_spider[t.getFrame()].draw(t.position.x,t.position.y)},this.debug=function(){ctx.fillStyle="yellow",this.getBounds().debug()},this.getBounds=function(){return t.getBounds()}}function RandomMovement(t,e){const i=e;var n=gsm.getState().world,s=t.position,o=new Vector2(0,0);this.randomUpdate=function(){o=a()};var a=function(){var t=new Vector2(0,0),e=getRandomInt(0,4);switch(e){case 3:t.x+=i;break;case 2:t.x-=i;break;case 1:t.y+=i;break;case 0:t.y-=i;break;default:console.error(e)}for(var a=n.getCells(s.x+o.x,s.y+o.y),r=0;r<a.length;r++){var l=a[r];isNull(l)||l.type!==CELLTYPE.WALL||(t=h())}return t},h=function(){return new Vector2(0,0)};this.update=function(){o.isZero()||(s.x+=o.x,s.y+=o.y)}}function Zombie(){var t=new Enemy([0,1]),e=new RandomMovement(t,1);this.init=function(){t.init()},this.randomUpdate=function(){e.randomUpdate()},this.setPosition=function(e,i){t.setPosition(e,i)},this.update=function(i){t.update(i),e.update()},this.render=function(){s_zombie[t.getFrame()].draw(t.position.x,t.position.y)},this.debug=function(){ctx.fillStyle="red",t.bounds.debug()},this.getBounds=function(){return t.getBounds()}}function Player(){const t=7,e=250,i=30;var n,s,o=0;const a=[0,1],h=0;this.init=function(){this.position=new Vector2(0,0),this.velocity=new Vector2(0,0),this.bounds=new Bound(this.position.x+h,this.position.y+h,32,32),s=new SwordAttack(this),n=0},this.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.bounds.x=t+h,this.bounds.y=e+h},this.onClick=function(t){s.attack(t)},this.update=function(t){this.velocity.reset(),69 in keysDown&&n>i&&(gsm.getState().bombManager.newBomb(this.position),n=0,console.log("add")),(87 in keysDown||38 in keysDown)&&(this.velocity.y-=e*t),(83 in keysDown||40 in keysDown)&&(this.velocity.y+=e*t),(65 in keysDown||37 in keysDown)&&(this.velocity.x-=e*t),(68 in keysDown||39 in keysDown)&&(this.velocity.x+=e*t);var o=gsm.getState().world,a=Boolean(o.collide(this));a||(this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.bounds.setPosition(this.position.x+h,this.position.y+h)),Boolean(this.velocity.isZero())||r(),s.update(),n++};var r=function(){o+=frames%t===0?1:0,o%=a.length};this.render=function(){s_player[o].draw(this.position.x,this.position.y)},this.debug=function(){ctx.fillStyle="cyan",this.bounds.debug(),s.debug()},this.dispose=function(){}}function SwordAttack(t){var e={TOP:0,BOTTOM:1,LEFT:2,RIGHT:3};const i=t;var n,s={position:new Vector2(0,0),attackTime:10,width:16,height:2*Cell.SIZE,visible:!1};this.update=function(){var t=i.position;s.position.x=t.x,s.position.y=t.y,s.visible&&(n+=1,n>=s.attackTime&&(s.visible=!1))};var o=function(t){var i=canvas.getBoundingClientRect(),n=t.clientX-i.left,o=t.clientY-i.top,a=!0,h=!0;return n<s.position.x&&(a=!1),o<s.position.y&&(h=!1),a&&h?e.RIGHT:a&&!h?e.BOTTOM:!a&&h?e.LEFT:a||h?0:e.TOP},a=function(t){};this.attack=function(t){var e=i.position;s.position.x=e.x,s.position.y=e.y,s.visible=!0,n=0,a(o(t))},this.debug=function(){s.visible&&ctx.fillRect(s.position.x,s.position.y,s.width,s.height)}}function World(){function t(t){this.active=0,this.cell=t}var e,i=[],n=2;const s=16,o=15;this.init=function(){for(var t=0;s>t;t++){i[t]=[];for(var e=0;o>e;e++){var n=CELLTYPE.AIR;(0===t||0===e||15===t||14==e)&&(n=CELLTYPE.WALL),i[t][e]=new Cell(t,e,n)}}this.randomObstacle(),this.createDoor()},this.reset=function(){n++,this.init()},this.randomObstacle=function(){const t=getRandomInt(0,n);for(var e=0;t>e;e++){var s=getRandomInt(1,15),o=getRandomInt(1,14),a=this.getCell(s,o),h=new Cell(a.position.x,a.position.y,CELLTYPE.WALL);delete i[s][o],i[s][o]=h}},this.collideWithDoor=function(t){return Boolean(t.bounds.collideWithEntity(e.cell.bounds))},this.createDoor=function(){var n=this.spawnCell(),s=new Cell(n.position.x,n.position.y,CELLTYPE.DOOR);e=new t(n),s.setDoor(e),i[n.position.x][n.position.y]=s},this.getCells=function(t,e){var i=parseInt(s*t/(Cell.SIZE*s)),n=parseInt(o*e/(Cell.SIZE*o));const a=2;for(var h=[],r=i;i+a>r;r++)for(var l=n;n+a>l;l++){var c=this.getCell(r,l);"undefined"!==c&&null!=c&&h.push(c)}return h},this.getCell=function(t,e){var n;return t>=0&&e>=0&&s>t&&o>e&&(n=i[t][e]),n};var a,h;this.collide=function(t){a=new Bound(t.bounds.x+t.velocity.x,t.bounds.y+t.velocity.y,t.bounds.width,t.bounds.height),h=this.getCells(a.x,a.y);for(var e=0;e<h.length;e++){var i=h[e];if(isNull(i))console.error("undefinied || null");else if(i.type===CELLTYPE.WALL&&!Boolean(a.collideWith(i.bounds)))return!0}return!1},this.spawnCell=function(){var t,e=!1;do{var i=Math.random()*canvas.width,n=Math.random()*canvas.height,s=parseInt(canvas.width*i/(Cell.SIZE*canvas.width)),o=parseInt(canvas.height*n/(Cell.SIZE*canvas.height));t=this.getCell(s,o),"undefined"!==t&&null!=t&&t.type===CELLTYPE.AIR&&(e=!0)}while(!Boolean(e));return t},this.update=function(t){},this.render=function(){for(var t=0;s>t;t++)for(var e=0;o>e;e++)i[t][e].render()},this.debug=function(){for(var t=0;s>t;t++)for(var e=0;o>e;e++)i[t][e].debug();ctx.fillStyle="red",a.debug(),ctx.fillStyle="blue";for(var t=0;t<h.length;t++)h[t].debug()},this.activateDoor=function(){e.active=1},this.dispose=function(){}}function Cell(t,e,i){this.position=new Vector2(t,e),this.bounds=new Bound(t*Cell.SIZE,e*Cell.SIZE,Cell.SIZE,Cell.SIZE),this.type=i,this.render=function(){var t=this.bounds.x,e=this.bounds.y;this.type===CELLTYPE.WALL?s_world_block.draw(t,e):this.type===CELLTYPE.AIR?s_world_air.draw(t,e):this.type===CELLTYPE.DOOR&&s_door[this.door.active].draw(t,e)},this.setDoor=function(t){this.door=t},this.debug=function(){this.type===CELLTYPE.WALL?(ctx.fillStyle="black",this.bounds.debug()):this.type===CELLTYPE.AIR?(ctx.beginPath(),ctx.rect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height),ctx.stroke()):this.type===CELLTYPE.DOOR&&(ctx.fillStyle="blue",this.bounds.debug())},this.text=function(){var t="["+this.position.x+"-"+this.position.y+"]";ctx.fillText(t,this.position.x*Cell.SIZE,this.position.y*Cell.SIZE)}}var s_splash,s_play_btn,s_menu_btn,s_spider,s_bomb,s_logo,s_door,s_player,s_zombie,s_world_block,s_world_air;Sprite.prototype.draw=function(t,e){ctx.drawImage(this.img,this.x,this.y,this.width,this.height,t,e,this.width,this.height)};const states={Splash:0,Menu:1,Play:2,GameOver:3};var CELLTYPE={WALL:0,AIR:1,DOOR:2};Cell.SIZE=32;const firstState=states.Splash,WIDTH=512,HEIGHT=480;var debug=!1,mute=!1,canvas,ctx,gsm,frames=0,keysDown={},load=function(){var t=new Image;t.onload=function(){initSprites(this),run()},t.src="img/sprite.png"},run=function(){canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),canvas.width=WIDTH,canvas.height=HEIGHT,document.getElementById("canvas").appendChild(canvas),addListeners(),gsm=new GameStateManager,gsm.changeState(firstState),loop()},addListeners=function(){addEventListener("keydown",function(t){keysDown[t.keyCode]=!0},!1),addEventListener("keyup",function(t){delete keysDown[t.keyCode]},!1);var t="touchstart";t="mousedown",addEventListener(t,function(t){gsm.onClick(t)},!1)},loop=function(){var t=Date.now(),e=t-then;update(e/1e3),render(),then=t,requestAnimationFrame(loop)},update=function(t){81 in keysDown&&(debug=!debug),frames++,gsm.update(t)},render=function(){ctx.fillStyle="black",ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillRect(0,0,canvas.width,canvas.height),gsm.render(ctx),Boolean(debug)&&gsm.debug(ctx)},then=Date.now(),muteSound=function(){var t=document.getElementById("mute");mute?(t.innerText="Disable Sounds",mute=!mute):(t.innerText="Enable Sounds",mute=!mute)};